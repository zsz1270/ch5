1.야후 파이낸스 문제점

yfinance 라이브러리를 제공함

종가 및 수정종가
당일 거래의 가장 마지막에 이루어진 거래가 종가
액면분할 ,증자 등의 이벤트 발생으로 인해 과거와 비교가능하게하기 위해 수정된 주가가 수정종가
액면분할
1의 가치를  일정비율로 분할하여 발행하는 주식의 총수를 늘리는 것이나 총액의 가치에는 변화가없다.
(총액의 가치는 그대로이고 주식의 총 수 및 주주의 수가 증가)

삼성전자는 2018년 5월 초에 50분의 1 액면분할을 시행해서 원래대로라면 종가 250만원대 , 수정종가 5만원대로 표시되야함

책에서는 17년 10월즈음만 누락되어있지만 현재 기준으로 더 많이 누락되어있다

=>잘못된 과거데이터때문에 실제 사용이 불가능
그래서 직접 시세 조회가 가능한 API를 만들기위한 5장

2.네이버 금융 데이터
네이버에서 제공하는 금융데이터를 통해 원하는 국내주식의 시세를 조회하려고한다
현재 조회한 데이터는 삼성전자의 9월이후 최근 시세입니다.
사용하기 위해 마리아db 로 일별 시세 데이터를 받아서써야함
네이버 금융 데이터는 수정종가를 제공하지 않는다


3.마리아db

MySQL 의 API 및 명령을 똑같이 사용가능
헤이디(Heidi)SQL로 GUI작업 수행
Pymysql 라이브러리로 파이썬에서 SQL문 실행가능

테이블 생성할때 인코딩방식 설정이 가능함
utf8을 사용할때 utf8_general_ci 와 utf8_unicode_ci  둘중에 하나를 사용할 수있다.
db생성시 utf8_제네럴_ci 사용하는 이유 : ÀÁÅåāă 등의 문자가 전부 A 로 치환되어 빠르게 정렬이 가능
db생성시 utf8_unicode_ci사용하는이유 :  문자의 예외없이 모두 정상적으로 처리 , 속도가 느림
우리는 어짜피 한글이므로 빠른 제너럴 ci사용이 유리하다고생각함

company_info 는 회사명과 종목코드 , 마지막업데이트날짜를 저장
daily_price 는 종목코드, 날짜, 시가, 고가, 저가, 종가 ,종가의 전일비(전일과의 비교량), 거래량
bigint 는 8바이트정수형

복합기본키 : 하나의 속성만으로는 기본키를 설정할수없을때 사용한다.
=>회사코드는 날짜가 바뀌면 중복이 가능하기때문에 날짜와 함께 복합키로 설정해주면 하루에 하나의 회사코드는 단 한번만 존재할수있다

이 db에 자동으로 혹은 실행시 데이터를 업데이트해주는 py
5.디비업데이터.py
정규시간으로 매일 3시 반에 증시가 닫히기 때문에 그뒤 5시에 자동으로 디비를 업데이트해주는 목적의 py

pip install pymysql
=> 파이썬에서 cousor 객체를 통해 sql문을 실행가능하게해줌

1)__init__(self)
=>생성자 py실행시 반드시 실행
	IF NOT EXISTS
	=>db연결시 테이블이 존재하지 않을경우에만 생성

__del__(self)
=>소멸자	py종료시 반드시 실행

2)종목코드구하기

KRX는 KOREA EXCHANGE 한국거래소이다
url은 한국거래소에서 제공되는 상장법인 목록 엑셀파일이다
이 엑셀을 문자열로 변환해 종목코드와 회사명 만을 가져온다


{:06d} 정수형 6자리 문자열 형태를 의미


3)종목코드 DB에 업데이트하기

db의 company_info 테이블을 읽어와서 데이터프레임으로 종목코드와 회사명으로 딕셔너리를 만들고
SELECT max구절로 가장최근 업데이트 날짜를 가져와서 구한날짜가 존재안하거나 오늘보다 이전일때만 업데이트실행

INSERT INTO 구문은 데이터행이 테이블에 존재하면 오류발생
그래서 REPLACE INTO 사용  : 동일데이터가 존재해도 UPDATE함

실행하면 종목코드와 회사명을 가져오는데 마지막 코드가 그시간에 상장되어있다는 뜻임

4)네이버 금융데이터를 읽어와 데이터프레임으로 변환

일별 시세의 마지막페이지를 구하고 (지난시간에 한것)

db에 넣기위해 한글 칼럼명을 영어로 바꿈
날짜데이터도 바꿔줌
바꾼 데이터들을 데이터프레임으로 바꿔줌

예외처리 : http 에러로 종료될수있어서 예외 처리를해줌 (나는 실제로 났었다)

5)변환된 데이터프레임 DB에 저장
db의 daily_price 테이블에 변환시킨 데이터 프레임을 넣어준다. 마찬가지로  REPLACE INTO 사용

6)DBUpdater.py 실행을 통해 얻은 칼럼들

6.디비업데이터를 통해 저장된 일별 시세를 직접 조회할수있는 API이다.

1)디비업데이터와 마찬가지로 db연결을 위해 생성자와 소멸자에 db 연결과 해제 설정해준다.

2) API로 조회할 회사의 코드를 company_info 테이블에서 가져옴

3)사용자가 조회할 회사와 시작및 끝날짜를 입력하면 db의 데이터를 변환해 출력해줌
입력방식에서 날짜의 형식이 의도한바와 달라도 자동으로 변환해 처리해줌
그리고 사용자가 날짜를 입력하지 않았더라도 자동으로 오늘날짜로부터 1년전으로 설정해줌
종료일은 오늘날짜로 설정해줌
그 후 입력받은 회사명과 코드를 비교해 코드를 선택하고 시세가 들어있는 테이블에서 그 코드에 해당되는 칼럼들을 출력해준다.